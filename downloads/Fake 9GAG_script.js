{"files":[{"id":"6ad710cf-13ea-48ee-ac12-2c5710daa70b","name":"main","type":"server_js","source":"var rankingNamen \u003d [];\nvar rankingScores \u003d [];\n\nfunction main() {\n\tvar DATA \u003d \u00271e8KpAxPjg0bXZzc61VI3V5NNmZBVPFSgNBxqOf0OPKc\u0027;\n\tvar data \u003d SpreadsheetApp.openById(DATA);\n\n\tvar META \u003d data.getSheets()[0];\n\tvar STATUS \u003d data.getSheets()[1];\n    var APPS \u003d data.getSheets()[2];\n    var BITLY \u003d data.getSheets()[3];\n\tvar BUFFER \u003d data.getSheets()[4];\n\n\tvar id_kolom \u003d 0;\n\tvar name_kolom \u003d 1;\n\tvar link_kolom \u003d 2;\n\tvar scam_kolom \u003d 3;\n\tvar extra_kolom \u003d 4;\n\tvar status_kolom \u003d 5;\n  \n    var bitly_link_kolom \u003d 0;\n    var bitly_created_kolom \u003d 1;\n    var bitly_views_kolom \u003d 2;\n    var bitly_forward_kolom \u003d 3;\n    var bitly_status_kolom \u003d 4;\n  \n    var overview_index \u003d 1;\n    var overview_status \u003d 2;\n    var overview_bitly \u003d 3;\n    var overview_bitly_current \u003d 10;\n    \n\tvar progstart \u003d new Date();\n\tvar timezone \u003d \u0027UTC\u0027;\n\t\n\tvar startIndex \u003d 2595;\n\tvar onlineTeller \u003d 0;\n\tvar endIndex \u003d SheetAccess.getValue(3, 1, STATUS);\n\tvar fase \u003d SheetAccess.getValue(0, 1, STATUS);\n\n\tif (fase \u003d\u003d\u003d 0) { // INDEXEREN\n\t\t// FASE SWITCHEN\n\t\tSheetAccess.setValue(0, 1, STATUS, 1);\n\n\t\t// INDEX\n\t\tindex(META, id_kolom, name_kolom, link_kolom, scam_kolom, startIndex,\n\t\t\t\tBUFFER);\n\n\t\t// STATUS UPDATEN\n\t\tvar progend \u003d new Date();\n\t\tvar timestamp \u003d Utilities.formatDate(new Date(), timezone,\n\t\t\t\t\"yyyy-MM-dd\u0027 at \u0027HH:mm:ss\u0027 (\" + timezone + \")\u0027\");\n\t\tSheetAccess.setValue(overview_index, 1, STATUS, timestamp);\n\t\tSheetAccess.setValue(overview_index, 2, STATUS, TimeFunctions.secondDiff(progstart,\n\t\t\t\tprogend)\n\t\t\t\t+ \u0027 sec\u0027);\n\n\t} else if (fase \u003d\u003d\u003d 1) { // STATUS CHECKEN\n\t\t// FASE SWITCHEN\n\t\tSheetAccess.setValue(0, 1, STATUS, 2);\n\t\t// CHECK ONLINE\n\t\tvar ok \u003d \u0027ok\u0027;\n\t\twhile (ok \u003d\u003d\u003d \u0027ok\u0027) {\n\t\t\tif (SheetAccess.getValue(startIndex + 2, scam_kolom, META) \u003d\u003d\u003d \"NO\") {\n\t\t\t\tok \u003d \u0027nok\u0027;\n\t\t\t}\n\t\t\tstartIndex +\u003d 1;\n\t\t\tif (SheetAccess.getValue(startIndex, status_kolom, META).substring(\n\t\t\t\t\t0, 7) !\u003d \u0027OFFLINE\u0027) {\n\t\t\t\tonlineTeller +\u003d pollFacebookpage(META, startIndex, status_kolom, name_kolom, id_kolom, timezone);\n\t\t\t}\n\t\t}\n\t\t// NOTIFY ME\n\t\tvar startIndexOud \u003d SheetAccess.getValue(4, 1, STATUS);\n\t\tvar onlineTellerOud \u003d SheetAccess.getValue(5, 1, STATUS);\n\t\tnotify(onlineTeller, startIndex, onlineTellerOud, startIndexOud);\n\n\t\t// STATUS UPDATEN\n\t\tvar progend \u003d new Date();\n\t\tvar timestamp \u003d Utilities.formatDate(new Date(), timezone,\n\t\t\t\t\"yyyy-MM-dd\u0027 at \u0027HH:mm:ss\u0027 (\" + timezone + \")\u0027\");\n\t\tSheetAccess.setValue(overview_status, 1, STATUS, timestamp);\n\t\tSheetAccess.setValue(overview_status, 2, STATUS, TimeFunctions.secondDiff(progstart,\n\t\t\t\tprogend)\n\t\t\t\t+ \u0027 sec\u0027);\n\t\tSheetAccess.setValue(4, 1, STATUS, startIndex);\n\t\tSheetAccess.setValue(5, 1, STATUS, onlineTeller);\n      \n    } else if (fase \u003d\u003d\u003d 2) { // BITLY CHECKEN\n        // FASE SWITCHEN\n\t\tSheetAccess.setValue(0, 1, STATUS, 0);\n      \n\t\t// CHECK STATS\n        var startIndex \u003d SheetAccess.getValue(overview_bitly_current,2,STATUS);\n        var totaal \u003d SheetAccess.getValue(overview_bitly_current,1,STATUS);\n        \n\t\twhile(true) {\n\t\t\tpollBitly(BITLY, startIndex, bitly_link_kolom, bitly_created_kolom, bitly_views_kolom, bitly_forward_kolom, bitly_status_kolom, timezone, BUFFER)\n            startIndex +\u003d 1;\n            startIndex \u003d startIndex % totaal;\n            \n            if(startIndex % 10 \u003d\u003d\u003d 0){\n              SheetAccess.setValue(overview_bitly_current,2,STATUS,startIndex);\n            }\n            if(startIndex \u003d\u003d\u003d 0){ //LOG A COMPLETED CYCLE\n              var timestamp \u003d Utilities.formatDate(new Date(), timezone,\n\t\t\t\t\"yyyy-MM-dd\u0027 at \u0027HH:mm:ss\u0027 (\" + timezone + \")\u0027\");\n\t\t      SheetAccess.setValue(overview_bitly, 1, STATUS, timestamp);\n            }\n        }\n    } else if (fase \u003d\u003d\u003d 3) { // EXTRA: GET LINKS ON ALL INDEXED PAGES\n      // FASE SWITCHEN\n      SheetAccess.setValue(0, 1, STATUS, 0);\n      \n      //SET VARS\n      var from \u003d 2614;\n      var till \u003d from+200;\n      var totallinks \u003d 0\n      var allLinks \u003d [];\n      \n      for(var pageindex \u003d from; pageindex\u003ctill;pageindex++){ // FOR EVERY PAGE\n        var id \u003d SheetAccess.getValue(pageindex,id_kolom,META);\n        var posts \u003d JSON.parse(getPosts(id));\n        for(var i \u003d 0; i \u003c posts.data.length; i++){ //FOR EVERY POST ONE THE PAGE\n          if(posts.data[i].message){\n            var start \u003d posts.data[i].message.indexOf(\u0027http\u0027);\n            if(start \u003d\u003d\u003d -1){\n              start \u003d posts.data[i].message.indexOf(\u0027bit.ly\u0027);\n            }\n            if(start \u003e -1){\n              var link \u003d posts.data[i].message.substring(start);\n              if(link.substring(0,6)\u003d\u003d\u003d\u0027bit.ly\u0027){\n                link \u003d \u0027http://\u0027+link;\n              }\n              if(allLinks.indexOf(link)\u003c0){\n                allLinks.push(link);\n                SheetAccess.setValue(totallinks, 0, BUFFER, link);\n                totallinks++;\n              }\n            }\n          }\n        }\n      }\n    } else if (fase \u003d\u003d\u003d 4) { // EXTRA: UNLIKE ALL POST FROM PAGES (takes a while)\n      // FASE SWITCHEN\n      SheetAccess.setValue(0, 1, STATUS, 0);\n      \n      //SET VARS\n      var from \u003d 2559;\n      var till \u003d from+200;\n\n      for(var pageindex \u003d from; pageindex\u003ctill;pageindex++){ // FOR EVERY PAGE\n        var id \u003d SheetAccess.getValue(pageindex, id_kolom, META);\n        var posts \u003d JSON.parse(getPosts(id));\n        for(var i \u003d 0; i \u003c posts.data.length; i++){ //FOR EVERY POST ONE THE PAGE\n          //SheetAccess.setValue(i, 0, BUFFER, posts.data[i]);\n          unlike(posts.data[i].id);\n        }\n      }\n\t} else if (fase \u003d\u003d\u003d 5) { // EXTRA: CHECK STATUS OF IDK and OK PAGES\n\t\t// FASE SWITCHEN\n        SheetAccess.setValue(0, 1, STATUS, 0);\n      \n        //SET VARS\n\t\tstartIndex \u003d endIndex;\n\t\tstartIndex \u003d 2480;\n\n\t\t// CHECK ONLINE\n\t\tvar ok \u003d \u0027ok\u0027;\n\t\twhile (ok \u003d\u003d\u003d \u0027ok\u0027) {\n\t\t\tif (SheetAccess.getValue(startIndex + 2, id_kolom, META) \u003d\u003d\u003d \"END\") {\n\t\t\t\tok \u003d \u0027nok\u0027;\n\t\t\t}\n\t\t\tstartIndex +\u003d 1;\n\t\t\tif (SheetAccess.getValue(startIndex, status_kolom, META).substring(\n\t\t\t\t\t0, 7) !\u003d \u0027OFFLINE\u0027) {\n\t\t\t\tonlineTeller +\u003d poll(META, startIndex, status_kolom, link_kolom);\n\t\t\t\tSheetAccess.setValue(0, 1, STATUS, 0);\n\t\t\t}\n\t\t}\n\t} else if (fase \u003d\u003d\u003d 6) { // EXTRA: HERRECHECK STATUS OFFLINE PAGES\n\t\t// FASE SWITCHEN\n\t\tSheetAccess.setValue(0, 1, STATUS, 0);\n\t\t// CHECK ONLINE\n\t\tstartIndex \u003d 2030;\n\t\tvar ok \u003d \u0027ok\u0027;\n\t\twhile (ok \u003d\u003d\u003d \u0027ok\u0027) {\n\t\t\tif (SheetAccess.getValue(startIndex, status_kolom, META).substring(\n\t\t\t\t\t0, 7) !\u003d \u0027OFFLINE\u0027) {\n\t\t\t\tok \u003d \u0027nok\u0027;\n\t\t\t}\n\t\t\tvar link \u003d SheetAccess.getValue(startIndex, link_kolom, META);\n\t\t\tvar status \u003d getPageStatus(link, BUFFER);\n\t\t\t// status afhandelen\n\t\t\tif (status \u003d\u003d\u003d \u0027ONLINE\u0027) {\n\t\t\t\tSheetAccess.setValue(startIndex, extra_kolom, META, \u0027ON\u0027);\n\t\t\t} else {\n\t\t\t\tSheetAccess.setValue(startIndex, extra_kolom, META, \u0027OFF\u0027);\n\t\t\t}\n\t\t\tstartIndex +\u003d 1;\n\t\t}\n    }\n}"},{"id":"20450d25-fda9-41d9-b773-14ecfac5731a","name":"pollFacebookpage","type":"server_js","source":"function pollFacebookpage(META, i, status_kolom, name_kolom, id_kolom, timezone) {\n\tvar rij \u003d i;\n  \n    var id \u003d SheetAccess.getValue(rij, id_kolom, META);\n    var parsed \u003d JSON.parse(get(id));\n  \n\tvar timestamp \u003d Utilities.formatDate(new Date(), timezone,\n\t\t\t\"yyyy-MM-dd\u0027 at \u0027HH:mm:ss\u0027 (\" + timezone + \")\u0027\");\n\n\t// status afhandelen\n\tif (parsed.error) {\n        SheetAccess.setValue(rij, status_kolom, META, \u0027OFFLINE \u0027 + timestamp);\n\t\treturn 0;\n\n\t} else {\n        SheetAccess.setValue(rij, name_kolom, META, parsed.name);\n\t\tSheetAccess.setValue(rij, status_kolom, META, \u0027STILL ONLINE \u0027+ timestamp);\n\t\treturn 1;\n\t}\n}"},{"id":"b9e4c2a7-c7c1-48c6-9c01-c6f00a4a7fd0","name":"notify","type":"server_js","source":"function notify(aantal, totaal, oudAantal, oudTotaal) {\n\tvar down \u003d totaal - aantal;\n\tvar downOud \u003d oudTotaal - oudAantal;\n\tvar diff \u003d down - downOud;\n\tvar body \u003d \u00279GAG: \u0027 + down + \u0027 down, \u0027 + aantal + \u0027 to go. (-\u0027 + diff + \u0027)\u0027;\n\tvar subject \u003d \u0027##IFTTTnotification\u0027;\n\tvar recipient \u003d \u0027trigger@recipe.ifttt.com\u0027;\n\n\tMailApp.sendEmail(recipient, subject, body);\n}\n\nfunction sendSMS(nr, bericht) {\n\tvar body \u003d nr\n\tvar subject \u003d \u0027#SMS\u0027;\n\tvar recipient \u003d \u0027trigger@recipe.ifttt.com\u0027;\n\tvar param \u003d {\n\t\thtmlBody : bericht\n\t}\n\tMailApp.sendEmail(recipient, subject, body, param);\n}"},{"id":"5fa9de25-7682-4203-905b-a3975837ee22","name":"facebookAPI","type":"server_js","source":"var appid \u003d \u00271248958628458764\u0027;\nvar appsecret \u003d \u00273530121489053699bfbb1be28ffbc625\u0027;\n\nfunction getAccessToken(appid, appsecret) {\n\tvar pagina \u003d \u0027https://graph.facebook.com/oauth/access_token?client_id\u003d\u0027\n\t\t\t+ appid + \u0027\u0026client_secret\u003d\u0027 + appsecret\n\t\t\t+ \u0027\u0026grant_type\u003dclient_credentials\u0027;\n\tvar options \u003d {\n\t\t\"method\" : \"GET\"\n\t};\n\tvar response \u003d UrlFetchApp.fetch(pagina, options);\n\treturn response;\n}\n\nfunction search(query, type) {\n\tvar access_token \u003d getAccessToken(appid, appsecret);\n\tvar token \u003d access_token.toString().replace(\u0027|\u0027, \u0027%7C\u0027);\n\tvar pagina \u003d \u0027https://graph.facebook.com/search?q\u003d\u0027 + query + \u0027\u0026type\u003d\u0027\n\t\t\t+ type + \u0027\u0026\u0027 + token + \u0027\u0026limit\u003d5000\u0027;\n\tvar options \u003d {\n\t\t\"method\" : \"GET\" //,\n\t};\n\tvar response \u003d UrlFetchApp.fetch(pagina, options);\n\treturn response;\n}\n\nfunction getPosts(page_id) {\n  if(page_id){\n    var access_token \u003d getAccessToken(appid, appsecret);\n    var token \u003d access_token.toString().replace(\u0027|\u0027, \u0027%7C\u0027);\n    var pagina \u003d \u0027https://graph.facebook.com/\u0027+page_id+\u0027/posts?format\u003djson\u0027 + \u0027\u0026\u0027 + token + \u0027\u0026limit\u003d5000\u0027;\n\tvar options \u003d {\n\t\t\"method\" : \"GET\",\n        \"muteHttpExceptions\" : true\n\t};\n\tvar response \u003d UrlFetchApp.fetch(pagina, options);\n\treturn response;\n  }\n}\n\nfunction unlike(post_id) {\n  if(post_id){\n    var access_token \u003d getAccessToken(appid, appsecret);\n    var token \u003d access_token.toString().replace(\u0027|\u0027, \u0027%7C\u0027);\n    var pagina \u003d \u0027https://graph.facebook.com/\u0027+post_id+\u0027/likes?format\u003djson\u0027 + \u0027\u0026\u0027 + token + \u0027\u0026limit\u003d5000\u0027;\n\tvar options \u003d {\n\t\t\"method\" : \"DELETE\"\n\t};\n\tvar response \u003d UrlFetchApp.fetch(pagina, options);\n\treturn response;\n  }\n}\n\nfunction get(id) {\n  if(id){\n    var access_token \u003d getAccessToken(appid, appsecret);\n    var token \u003d access_token.toString().replace(\u0027|\u0027, \u0027%7C\u0027);\n    var pagina \u003d \u0027https://graph.facebook.com/v2.8/\u0027+id+\u0027?\u0027 + token;\n\tvar options \u003d {\n\t\t\"method\" : \"GET\",\n        \"muteHttpExceptions\" : true\n\t};\n\tvar response \u003d UrlFetchApp.fetch(pagina, options);\n\treturn response;\n  }\n}\n"},{"id":"7a07b69c-6d52-4aa0-bef5-66d212057ab8","name":"index","type":"server_js","source":"function index(META, id_kolom, name_kolom, link_kolom, scam_kolom, startIndex,\n\t\tBUFFER) {\n    var chars \u003d [\u0027.\u0027, \u0027,\u0027, \u0027#\u0027, \u0027\"\u0027, \u0027;\u0027, \u0027\\\u0027\u0027, \u0027-\u0027, \u0027/\u0027, \u0027+\u0027, \u0027|\u0027, \u0027_\u0027];\n  \n\tvar result1 \u003d JSON.parse(search(\u0027snapchat\u0027, \u0027page\u0027));\n    //SheetAccess.setValue(0, 0, BUFFER, result1.data);\n    var result2 \u003d JSON.parse(search(\u0027Whats\u0027, \u0027page\u0027));\n    //SheetAccess.setValue(1, 0, BUFFER, result2.paging);\n    var result3 \u003d JSON.parse(search(\u00279 gag\u0027, \u0027page\u0027));\n    //SheetAccess.setValue(2, 0, BUFFER, result3.data);\n  \n\n\t// Index\n\tvar map \u003d new Array();\n\tvar index \u003d startIndex;\n\tvar value \u003d SheetAccess.getValue(index, id_kolom, META);\n  \n\twhile (value !\u003d \"END\") {\n\t\tmap[value] \u003d index;\n\t\tindex +\u003d 1;\n\t\tvalue \u003d SheetAccess.getValue(index, id_kolom, META);\n\t}\n  \n    // Add 9GAG\n\tfor (page in result3.data) {\n\t\tvar entry \u003d result3.data[page];\n        if (entry.name.substring(0,1).toUpperCase() \u003d\u003d \u00279\u0027){\n\t\t  if (includesOneOf(entry.name, chars, BUFFER)) {\n\t\t\tvar locatie \u003d map[entry.id];\n\t\t\tif (locatie \u003d\u003d\u003d undefined) {\n\t\t\t\tmap[SheetAccess.getValue(index, id_kolom, META)] \u003d index;\n\t\t\t\tSheetAccess.setValue(index, name_kolom, META, entry.name);\n\t\t\t\tSheetAccess.setValue(index, id_kolom, META, entry.id);\n\t\t\t\tSheetAccess.setValue(index, scam_kolom, META, \u0027TBD\u0027);\n\t\t\t\tindex +\u003d 1;\n\t\t\t}\n\t\t  }\n        }\n\t}\n  \n    // Add Snapchat\n\tfor (page in result1.data) {\n\t\tvar entry \u003d result1.data[page];\n        if (entry.name.substring(0,3).toUpperCase() \u003d\u003d \u0027SNA\u0027){\n\t\t  if (includesOneOf(entry.name, chars, BUFFER)) {\n\t\t\tvar locatie \u003d map[entry.id];\n\t\t\tif (locatie \u003d\u003d\u003d undefined) {\n\t\t\t\tmap[SheetAccess.getValue(index, id_kolom, META)] \u003d index;\n\t\t\t\tSheetAccess.setValue(index, name_kolom, META, entry.name);\n\t\t\t\tSheetAccess.setValue(index, id_kolom, META, entry.id);\n\t\t\t\tSheetAccess.setValue(index, scam_kolom, META, \u0027TBD\u0027);\n\t\t\t\tindex +\u003d 1;\n\t\t\t}\n\t\t  }\n        }\n\t}\n  \n    // Add Whatsapp\n\tfor (page in result2.data) {\n\t\tvar entry \u003d result2.data[page];\n        if (entry.name.substring(0,6).toUpperCase() \u003d\u003d \u0027WHATSA\u0027){\n          if (includesOneOf(entry.name, chars, BUFFER)) {\n            var locatie \u003d map[entry.id];\n            if (locatie \u003d\u003d\u003d undefined) {\n              map[SheetAccess.getValue(index, id_kolom, META)] \u003d index;\n              SheetAccess.setValue(index, name_kolom, META, entry.name);\n              SheetAccess.setValue(index, id_kolom, META, entry.id);\n              SheetAccess.setValue(index, scam_kolom, META, \u0027TBD\u0027);\n              index +\u003d 1;\n            }\n          }\n        }\n\t}\n \n\tSheetAccess.setValue(index, 0, META, \u0027END\u0027);\n}"},{"id":"dd040ac8-169a-430b-99e5-a73964ccca5c","name":"pollBitly","type":"server_js","source":"function pollBitly(BITLY, i, link_kolom, created_kolom, views_kolom, forward_kolom, status_kolom, timezone, BUFFER) {\n\tvar rij \u003d i;\n\tvar link \u003d SheetAccess.getValue(rij, link_kolom, BITLY);\n  var timestamp \u003d Utilities.formatDate(new Date(), timezone, \"yyyy-MM-dd\u0027T\u0027HH:mm:ss.SSS\u0027+00:00\u0027\");\n  \n    if(link.indexOf(\u0027bit.ly\u0027)\u003e0){ //BITLY\n      var html \u003d Web.getHTML(link+\u0027+\u0027);\n      var startindex \u003d html.indexOf(\"long_url_no_protocol\");\n      var eindindex \u003d html.indexOf(\"branded_short_domain_status\");\n  \n      var data \u003d html.substring(startindex-2, eindindex-4);\n      var list \u003d data.split(\",\\n\");\n      \n      var json0 \u003d JSON.parse(list[0]);\n      var json1 \u003d JSON.parse(list[1]);\n      \n      var created \u003d Utilities.formatDate(new Date(json0.created_at*1000), timezone,\n                                         \"yyyy-MM-dd\u0027T\u0027HH:mm:ss.SSS\u0027+00:00\u0027\");\n      var views \u003d json1.user_clicks;\n      var forward \u003d json0.long_url;\n      var status \u003d list[2];\n      \n    } else if (link.indexOf(\u0027goo.gl\u0027)\u003e0){ //GOOGLE\n      var html \u003d Web.getHTML(\u0027https://www.googleapis.com/urlshortener/v1/url?shortUrl\u003d\u0027+link+\u0027\u0026projection\u003dFULL\u0026key\u003dAIzaSyDlxAdgGRwg4r7LtPdwFaVCz9c1i0Aex0s\u0027);\n      var response \u003d JSON.parse(html);\n      var created \u003d response.created;\n      var status \u003d \u0027false\u0027;\n      if (response.analytics){\n        var views \u003d response.analytics.allTime.shortUrlClicks;\n      } else {\n        status \u003d \u0027true\u0027;\n      }\n      var forward \u003d response.longUrl;\n    }\n  \n  // Write\n  if (SheetAccess.getValue(rij, forward_kolom, BITLY) \u003d\u003d \u0027\u0027) {\n    SheetAccess.setValue(rij, created_kolom, BITLY, created);\n    SheetAccess.setValue(rij, forward_kolom, BITLY, forward);\n  }\n  \n  if (status \u003d\u003d \u0027false\u0027) {\n    SheetAccess.setValue(rij, status_kolom, BITLY, timestamp + \u0027 ONLINE\u0027);\n    SheetAccess.setValue(rij, views_kolom, BITLY, views);\n    return 1;\n  } else {\n    SheetAccess.setValue(rij, status_kolom, BITLY, timestamp + \u0027 OFFLINE\u0027);\n    return 0;\n  }\n}\n"},{"id":"69f46939-1c4c-4b7f-9be7-ef2f8e979a75","name":"includesOneOf","type":"server_js","source":"function includesOneOf(target, pattern, BUFFER){\n    var value \u003d 0;\n    for (character in pattern) {\n      var index \u003d target.indexOf(pattern[character]);\n      if(index \u003e -1){\n        return true;\n      }\n    }\n    return false;\n}\n"}]}